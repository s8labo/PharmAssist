<!DOCTYPE html>
<html>
<head>
  <title>Talking Head - minimal example</title>

  <style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica, sans-serif;
    }

    h1 {
        text-align: center;
        padding: 20px;
        background-color: #f0f0f0;
    }

    #container {
        display: flex;
        height: 80vh; /* Adjust the height as needed */
        background-color: dimgray;
        color: white;
        max-width: 800px;
        margin: auto;
    }

    #webchat {
        flex: 3; /* This will make the chat take 3 parts of the available space */
        font-size: 20px;
        background-color: #AEC6CF; /* Light background for the chatbot area */
        padding: 20px;
        box-sizing: border-box;
    }

    div.ac-container.ac-adaptiveCard .ac-textBlock p, span.ac-textRun, .ac-input.ac-textInput {
        font-size: 20px!important;
        line-height: 27px;
    }

    #avatar-container {
        flex: 1; /* This will make the avatar take 1 part of the available space */
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #555; /* Dark background for the avatar area */
        padding: 20px;
        box-sizing: border-box;
    }

    #avatar {
        width: 100%; /* Avatar will fit the width of its container */
        height: auto; /* Maintain aspect ratio */
    }

    #loading {
        text-align: center;
        margin-top: 10px;
        font-size: 16px;
        color: #FFF;
    }
  </style>
  
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script type="importmap">
  { "imports":
    {
      "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js/+esm",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/",
      "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.2/modules/talkinghead.mjs"
    }
  }
  </script>

  <script type="module">
    import { TalkingHead } from "talkinghead";

    let head;

    document.addEventListener('DOMContentLoaded', async function(e) {
      const nodeAvatar = document.getElementById('avatar');
      head = new TalkingHead(nodeAvatar, {
        ttsEndpoint: "https://eu-texttospeech.googleapis.com/v1beta1/text:synthesize",
        ttsApikey: "AIzaSyD2DvM6vDBZm1SluT6h5iCpJPpjwXzcv5M",
        lipsyncModules: ["en", "fi"],
        cameraView: "upper"
      });

      const nodeLoading = document.getElementById('loading');
      try {
        nodeLoading.textContent = "Loading...";
        await head.showAvatar({
          url: 'https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb',
          body: 'F',
          avatarMood: 'neutral',
          ttsLang: "de-DE",
          ttsVoice: "de-DE-Standard-A",
          lipsyncLang: 'de'
        }, (ev) => {
          if (ev.lengthComputable) {
            let val = Math.min(100, Math.round(ev.loaded / ev.total * 100));
            nodeLoading.textContent = "Loading " + val + "%";
          }
        });
        nodeLoading.style.display = 'none';
      } catch (error) {
        console.log(error);
        nodeLoading.textContent = error.toString();
      }
    });
  </script>
</head>

<body>
  <div id="container">
    <div id="webchat" role="main">
      <div class="typing-animation"></div>
    </div>
    <div id="avatar-container">
      <div id="avatar"></div>
      <div id="loading"></div>
    </div>
  </div>
  
  <script>
    (async function() {
      const fetchSpeechServicesCredentials = {
        credentials: {
          region: 'germanywestcentral',
          subscriptionKey: '724b12cefed2442c9df696992b249f89'
        }
      }

      async function createHybridPonyfillFactory({ credentials }) {
        const speechServicesPonyfillFactory = await window.WebChat.createCognitiveServicesSpeechServicesPonyfillFactory({
          credentials
        });

        const webSpeechPonyfillFactory = await window.WebChat.createBrowserWebSpeechPonyfillFactory();

        return options => {
          const speechServicesPonyfill = speechServicesPonyfillFactory(options);
          const webSpeechPonyfill = webSpeechPonyfillFactory(options);

          return {
            SpeechGrammarList: webSpeechPonyfill.SpeechGrammarList,
            SpeechRecognition: webSpeechPonyfill.SpeechRecognition,
            speechSynthesis: speechServicesPonyfill.speechSynthesis,
            SpeechSynthesisUtterance: speechServicesPonyfill.SpeechSynthesisUtterance
          };
        };
      }

      const styleSet = window.WebChat.createStyleSet({
        rootHeight: '100%',
        rootWidth: '100%',
        backgroundColor: '#AEC6CF'
      });

      const avatarOptions = {
        botAvatarInitials: 'PA',
        userAvatarInitials: 'U'
      };

      window.WebChat.renderWebChat({
        directLine: window.WebChat.createDirectLine({
          token: 'AavR0Oh2MoQ.k8agJWGKvkYtM92I0013G-A3eObi4iVxVVGEcZFYLY4'
        }),
        webSpeechPonyfillFactory: await createHybridPonyfillFactory({ credentials: fetchSpeechServicesCredentials }),
        enableTelemetry: false,
        styleSet,
        styleOptions: avatarOptions,
        botName: 'PharmAssistant'
      }, document.getElementById('webchat'));
    })().catch(err => console.error(err));
  </script>
</body>
</html>
