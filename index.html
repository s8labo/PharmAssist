<!DOCTYPE html>
<html>
<head>
  <title>PharmAssistant</title>
  <link rel="stylesheet" href="style.css">
  <!-- <style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica, sans-serif;
    }

    .outer-container {
      display: flex;
      flex-direction: row;
    }

    h1 {
        text-align: center;
        padding: 20px;
        background-color: #f0f0f0;
    }

    #webchat {
        height: 80vh; /* Adjust the percentage as needed */
        width: 100%;
        font-size: 20px;
    }
    div.ac-container.ac-adaptiveCard .ac-textBlock p, span.ac-textRun, .ac-input.ac-textInput {
      font-size: 20px!important;
      line-height: 27px;
    }
    body, html { width:100%; height:100%; max-width: 800px; margin: auto; position: relative; background-color: dimgray; color: white; }
    #avatar { display: block; width:40%; height:40%; }
    #controls { display: block; position: absolute; top: 10px; left: 10px; right: 10px; height: 50px; }
    #text { position: absolute; width: Calc( 100% - 110px ); height: 100%; top: 0; left: 0; bottom: 0; right: 110px; font-family: Arial; font-size: 20px; }
    #speak { block; position: absolute; top: 0; bottom: 0; right: 0; height: 100%; width: 100px; font-family: Arial; font-size: 20px; }
    #loading { display: block; position: absolute; bottom: 10px; left: 10px; right: 10px; height: 50px; font-family: Arial; font-size: 20px; }
  </style> -->
<script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script type="importmap">
  { "imports":
    {
      "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js/+esm",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/",
      "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.2/modules/talkinghead.mjs"
    }
  }
  </script>

  <script type="module">
    import { TalkingHead } from "talkinghead";

    let head;

    document.addEventListener('DOMContentLoaded', async function(e) {

      const nodeAvatar = document.getElementById('avatar');
      head = new TalkingHead( nodeAvatar, {
        ttsEndpoint: "https://eu-texttospeech.googleapis.com/v1beta1/text:synthesize",
        ttsApikey: "AIzaSyD2DvM6vDBZm1SluT6h5iCpJPpjwXzcv5M", 
        lipsyncModules: ["en", "fi"],
        cameraView: "upper"
      });

      // Load and show the avatar
      const nodeLoading = document.getElementById('loading');
      try {
        nodeLoading.textContent = "Loading...";
        await head.showAvatar( {
          url: 'https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?morphTargets=ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown&textureSizeLimit=1024&textureFormat=png',
          body: 'F',
          avatarMood: 'neutral',
          ttsLang: "de-DE",
          ttsVoice: "de-DE-Standard-A",
          lipsyncLang: 'de'
        }, (ev) => {
          if ( ev.lengthComputable ) {
            let val = Math.min(100,Math.round(ev.loaded/ev.total * 100 ));
            nodeLoading.textContent = "Loading " + val + "%";
          }
        });
        nodeLoading.style.display = 'none';
      } catch (error) {
        console.log(error);
        nodeLoading.textContent = error.toString();
      }

      // head.speakText("hallo");

      // Speak when clicked
      // const nodeSpeak = document.getElementById('speak');
      // nodeSpeak.addEventListener('click', function () {
      //   try {
      //     const text = document.getElementById('text').value;
      //     if ( text ) {
      //       head.speakText( "test" );
      //     }
      //   } catch (error) {
      //     console.log(error);
      //   }
      // });

    // await initializeHead();

    });

    (async function() {
        const fetchSpeechServicesCredentials = {
          credentials: {
                region: 'germanywestcentral',
                subscriptionKey: '724b12cefed2442c9df696992b249f89'
            }
        }

        async function createHybridPonyfillFactory({ credentials }) {
          const speechServicesPonyfillFactory = await window.WebChat.createCognitiveServicesSpeechServicesPonyfillFactory(
            {
              credentials
            }
          );

          const webSpeechPonyfillFactory = await window.WebChat.createBrowserWebSpeechPonyfillFactory();

          return options => {
            const speechServicesPonyfill = speechServicesPonyfillFactory(options);
            const webSpeechPonyfill = webSpeechPonyfillFactory(options);

            return {
              SpeechGrammarList: webSpeechPonyfill.SpeechGrammarList,
              SpeechRecognition: webSpeechPonyfill.SpeechRecognition,

              speechSynthesis: speechServicesPonyfill.speechSynthesis,
              SpeechSynthesisUtterance: speechServicesPonyfill.SpeechSynthesisUtterance
            };
          };
        }

        const styleSet = window.WebChat.createStyleSet({
            rootHeight: '100%',
            rootWidth: '100%',
            backgroundColor: '#AEC6CF'
        });

        const avatarOptions = {
            botAvatarInitials: 'PA',
            userAvatarInitials: 'U'
        };
        // Function to simulate delay
        const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

        const sendMessageWithDelay = async (message) => {
            directLine.postActivity({ type: 'message', text: message });

            // Introduce a delay of 3 seconds before displaying the bot's response
            await delay(5000);

            // Fetch the activities from the conversation and display them
            const activities = await directLine.getActivity();
            activities.forEach(activity => displayActivity(activity));
        };

        const displayActivity = (activity) => {
            // Code to display the activity in your web chat interface
            // This may involve updating the DOM or using WebChat's APIs
        };

        // Create a Redux store with middleware to capture incoming activities
        const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
          if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
            const event = new Event('webchatincomingactivity');

            // Attach the bot's activity (message) to the custom event
            event.data = action.payload.activity;
            window.dispatchEvent(event);
          }

          return next(action);
        });


        window.WebChat.renderWebChat({
            directLine: window.WebChat.createDirectLine({
                token: 'AavR0Oh2MoQ.k8agJWGKvkYtM92I0013G-A3eObi4iVxVVGEcZFYLY4'
            }),
            store,
            sendTyping: true,
            // webSpeechPonyfillFactory,
            webSpeechPonyfillFactory: await createHybridPonyfillFactory({ credentials: fetchSpeechServicesCredentials }),
            enableTelemetry: false,
            styleSet,
            styleOptions: avatarOptions,
            botName: 'PharmAssistant',
            sendMessage: sendMessageWithDelay,

        }, document.getElementById('webchat'));

        // Event listener for incoming bot activities
        window.addEventListener('webchatincomingactivity', ({ data }) => {
          if (data.type === 'message' && data.from.role === 'bot') {
            const botMessage = data.text;
            console.log(`Bot says: ${botMessage}`);

            // Make the avatar speak the bot message using TTS
            if (typeof head !== 'undefined' && head.speakText) {
              head.speakText(botMessage); // Avatar speaks the bot's message
            } else {
              console.error('Avatar head is not initialized.');
            }
          }
        });

        // Focus on Web Chat for better user experience
        document.querySelector('#webchat > *').focus();
      })().catch(err => console.error(err));

  </script>
</head>

<body>
<div id="left-panel">
    <!-- <div id="avatar"> -->
      <!-- <div id="controls"> -->
<!--         <input id="text" type="text" value="Hi there. How are you? I'm fine.">
        <input id="speak" type="button" value="Speak"> -->
      <!-- </div> -->
<!--     </div>
    <div id="loading">Loading...</div> -->
</div>

<div id="right-panel">
    <div id="avatar"></div>
    <div id="loading">Loading...</div>
    <div id="webchat" role="main">
      <div class="typing-animation"></div>
    </div>
</div>
<script>
      
    </script>
  
</body>
</html>